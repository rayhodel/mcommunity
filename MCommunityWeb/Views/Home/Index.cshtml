@{
    ViewData["Title"] = "MCommunity Lookup";
}

<div class="hero-section">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-10 col-lg-8">
                <div class="text-center mb-4">
                    <h1 class="display-4 fw-bold text-white mb-2">MCommunity Lookup</h1>
                    <p class="text-white-50">Search for people and groups at the University of Michigan</p>
                </div>
                
                <div class="card search-card shadow-lg">
                    <div class="card-body p-4">
                        <div class="input-group input-group-lg mb-3">
                            <span class="input-group-text bg-white border-end-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                                    <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                                </svg>
                            </span>
                            <input type="text" id="searchInput" class="form-control border-start-0" placeholder="Enter uniqname or group name" aria-label="Search">
                            <button class="btn btn-primary px-4" type="button" id="searchBtn">
                                <span class="btn-text">Lookup</span>
                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            </button>
                        </div>
                        
                        <div class="text-end">
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#settingsModal">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-gear me-1" viewBox="0 0 16 16">
                                    <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
                                    <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319z"/>
                                </svg>
                                API Settings
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10 col-lg-8">
            <div id="resultsArea" class="mt-4" style="display:none;">
                <div class="card shadow-sm result-card">
                    <div class="card-header">
                        <h5 class="mb-0">Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="formattedResult"></div>
                        <div class="mt-3">
                            <a class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" href="#jsonCollapse" role="button" aria-expanded="false" aria-controls="jsonCollapse">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-code-square me-1" viewBox="0 0 16 16">
                                    <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
                                    <path d="M6.854 4.646a.5.5 0 0 1 0 .708L4.207 8l2.647 2.646a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 0 1 .708 0zm2.292 0a.5.5 0 0 0 0 .708L11.793 8l-2.647 2.646a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708 0z"/>
                                </svg>
                                View Raw JSON
                            </a>
                        </div>
                        <div class="collapse mt-3" id="jsonCollapse">
                            <pre id="jsonResult" class="p-3 rounded"></pre>
                        </div>
                    </div>
                </div>
            </div>
             <div id="errorArea" class="alert alert-danger shadow-sm mt-4" style="display:none;"></div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="settingsModalLabel">API Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="appIdInput" class="form-label">Application ID (DN)</label>
                    <input type="text" class="form-control" id="appIdInput" placeholder="cn=...">
                </div>
                <div class="mb-3">
                    <label for="secretInput" class="form-label">Secret</label>
                    <input type="password" class="form-control" id="secretInput">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveSettingsBtn">Save</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const appIdInput = document.getElementById('appIdInput');
            const secretInput = document.getElementById('secretInput');
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');
            const searchBtn = document.getElementById('searchBtn');
            const searchInput = document.getElementById('searchInput');
            const resultsArea = document.getElementById('resultsArea');
            const jsonResult = document.getElementById('jsonResult');
            const errorArea = document.getElementById('errorArea');

            // Load settings
            const storedAppId = localStorage.getItem('mcommunity_appId');
            const storedSecret = localStorage.getItem('mcommunity_secret');
            
            if (storedAppId) appIdInput.value = storedAppId;
            if (storedSecret) secretInput.value = storedSecret;

            // Save settings
            saveSettingsBtn.addEventListener('click', function() {
                localStorage.setItem('mcommunity_appId', appIdInput.value);
                localStorage.setItem('mcommunity_secret', secretInput.value);
                var modal = bootstrap.Modal.getInstance(document.getElementById('settingsModal'));
                modal.hide();
            });

            // Search
            function performSearch() {
                const query = searchInput.value.trim();
                const appId = localStorage.getItem('mcommunity_appId');
                const secret = localStorage.getItem('mcommunity_secret');

                if (!query) return;
                if (!appId || !secret) {
                    alert('Please configure API settings first.');
                    new bootstrap.Modal(document.getElementById('settingsModal')).show();
                    return;
                }

                resultsArea.style.display = 'none';
                errorArea.style.display = 'none';
                searchBtn.disabled = true;
                searchBtn.querySelector('.btn-text').textContent = 'Searching...';
                searchBtn.querySelector('.spinner-border').classList.remove('d-none');

                fetch('/Home/Search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query, appId, secret })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text || response.statusText) });
                    }
                    return response.json();
                })
                .then(data => {
                    resultsArea.style.display = 'block';
                    jsonResult.textContent = JSON.stringify(data, null, 2);
                    displayFormattedResult(data);
                })
                .catch(error => {
                    errorArea.textContent = 'Error: ' + error.message;
                    errorArea.style.display = 'block';
                })
                .finally(() => {
                    searchBtn.disabled = false;
                    searchBtn.querySelector('.btn-text').textContent = 'Lookup';
                    searchBtn.querySelector('.spinner-border').classList.add('d-none');
                });
            }

            function displayFormattedResult(data) {
                const formattedResult = document.getElementById('formattedResult');
                formattedResult.innerHTML = '';
                
                if (data.uid) {
                    // Person result
                    formattedResult.innerHTML = `
                        <div class="result-person">
                            <div class="d-flex align-items-center mb-3">
                                <div class="avatar-circle me-3">${data.displayName ? data.displayName.charAt(0).toUpperCase() : data.uid.charAt(0).toUpperCase()}</div>
                                <div>
                                    <h4 class="mb-0">${data.displayName || data.uid}</h4>
                                    <span class="badge bg-primary">Person</span>
                                </div>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="info-item">
                                        <strong>Uniqname:</strong>
                                        <span>${data.uid}</span>
                                    </div>
                                </div>
                                ${data.mail && data.mail.length > 0 ? `
                                <div class="col-md-6">
                                    <div class="info-item">
                                        <strong>Email:</strong>
                                        <span><a href="mailto:${data.mail[0]}">${data.mail[0]}</a></span>
                                    </div>
                                </div>
                                ` : ''}
                                ${data.telephoneNumber && data.telephoneNumber.length > 0 ? `
                                <div class="col-md-6">
                                    <div class="info-item">
                                        <strong>Phone:</strong>
                                        <span><a href="tel:${data.telephoneNumber[0]}">${data.telephoneNumber[0]}</a></span>
                                    </div>
                                </div>
                                ` : ''}
                                ${data.title && data.title.length > 0 ? `
                                <div class="col-md-6">
                                    <div class="info-item">
                                        <strong>Title:</strong>
                                        <span>${data.title.join(', ')}</span>
                                    </div>
                                </div>
                                ` : ''}
                                ${data.umichInstRoles && data.umichInstRoles.length > 0 ? `
                                <div class="col-12">
                                    <div class="info-item">
                                        <strong>Affiliations:</strong>
                                        <div class="mt-2">
                                            ${data.umichInstRoles.map(role => `<span class="badge bg-secondary me-1 mb-1">${role}</span>`).join('')}
                                        </div>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                } else if (data.groupName || data.cn) {
                    // Group result
                    const groupName = data.groupName || data.cn;
                    formattedResult.innerHTML = `
                        <div class="result-group">
                            <div class="d-flex align-items-center mb-3">
                                <div class="avatar-circle-group me-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-people-fill" viewBox="0 0 16 16">
                                        <path d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1H7Zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6Zm-5.784 6A2.238 2.238 0 0 1 5 13c0-1.355.68-2.75 1.936-3.72A6.325 6.325 0 0 0 5 9c-4 0-5 3-5 4s1 1 1 1h4.216ZM4.5 8a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="mb-0">${groupName}</h4>
                                    <span class="badge bg-success">Group</span>
                                </div>
                            </div>
                            <div class="row g-3">
                                ${data.groupEmail || data.umichGroupEmail ? `
                                <div class="col-md-6">
                                    <div class="info-item">
                                        <strong>Email:</strong>
                                        <span><a href="mailto:${data.groupEmail || data.umichGroupEmail}@@umich.edu">${data.groupEmail || data.umichGroupEmail}@@umich.edu</a></span>
                                    </div>
                                </div>
                                ` : ''}
                                ${data.description || data.umichDescription ? `
                                <div class="col-12">
                                    <div class="info-item">
                                        <strong>Description:</strong>
                                        <span>${data.description || data.umichDescription}</span>
                                    </div>
                                </div>
                                ` : ''}
                                ${data.owners && data.owners.length > 0 ? `
                                <div class="col-12">
                                    <div class="info-item">
                                        <strong>Owners:</strong>
                                        <span class="text-muted">${data.owners.length} owner(s)</span>
                                    </div>
                                </div>
                                ` : ''}
                                ${data.members && data.members.length > 0 ? `
                                <div class="col-12">
                                    <div class="info-item">
                                        <strong>Members:</strong>
                                        <span class="text-muted">${data.members.length} member(s)</span>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
            }

            searchBtn.addEventListener('click', performSearch);
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performSearch();
            });
        });
    </script>
}
